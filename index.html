<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redzone Super Bowl Squares</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --muted:#98a2b3;
      --text:#e6eaf2;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --danger:#ef4444;
      --grid:#2a3445;
      --cell:#0f172a;
      --cellTaken:#111827;
      --cellHover:#16213a;
      --radius:14px;
      --attention:#fbbf24;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #132033 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:22px auto; padding:0 14px 28px;}
    header{
      background: linear-gradient(180deg, rgba(34,197,94,.12), rgba(96,165,250,.08));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 14px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    h1{font-size:18px; margin:0 0 6px 0; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:13px; line-height:1.35;}
    .sub.attention{
      color: var(--attention);
      font-weight: 900;
      letter-spacing: .15px;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }
    .pillRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;}
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    .pill b{color: var(--accent)}
    .btn{
      cursor:pointer;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.primary{background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35);}
    .btn.subtle{background: rgba(96,165,250,.10); border-color: rgba(96,165,250,.22);}
    .btn.warn{background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.30);}
    .btn.danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.30);}

    .adminBox{
      min-width: 290px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px;
    }
    .adminBox h3{
      margin:0 0 8px 0;
      font-size: 12px;
      letter-spacing:.2px;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .adminBox .adminHint{
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
    }
    .adminBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .publicBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .gridCard{
      margin-top:16px;
      background: rgba(18,24,38,.72);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .teamInput{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 10px;
      border-radius: 12px;
      user-select:none;
    }
    .teamInput label{font-size:12px; color:var(--muted)}
    .teamInput input{
      width:160px; border:none; outline:none; background:transparent;
      color:var(--text); font-weight:700; font-size:13px;
    }

    .boardArea{position:relative; padding-top:54px; padding-left:60px;}
    .team1Top{position:absolute; top:0; left:60px; right:0; display:flex; justify-content:center; pointer-events:auto;}
    .team2Side{position:absolute; top:54px; left:0; bottom:0; width:60px; display:flex; align-items:center; justify-content:center; pointer-events:auto;}
    .team2Side .teamInput{transform: rotate(-90deg); transform-origin:center;}

    .boardScroll{overflow-x:auto; -webkit-overflow-scrolling: touch; padding-bottom:6px;}
    .boardScroll::-webkit-scrollbar{height:8px;}
    .boardScroll::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:999px;}

    .board{
      display:grid;
      grid-template-columns: 48px repeat(10, minmax(0, 1fr));
      gap:6px;
      border-top: 1px solid rgba(255,255,255,.06);
      padding-top:10px;
      min-width:760px;
    }
    .hcell,.lcell,.cell{
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      min-height:46px;
      display:flex; align-items:center; justify-content:center;
      text-align:center; padding:6px; line-height:1.05;
    }
    .hcell,.lcell{
      background: rgba(96,165,250,.10);
      border-color: rgba(96,165,250,.22);
      font-weight:800; color:#dbeafe;
      user-select:none;
    }
    .cornerHidden{
      background: transparent !important;
      border-color: transparent !important;
      box-shadow:none !important;
      color: transparent !important;
    }
    .cell{
      background: rgba(15,23,42,.85);
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
      font-size:12px; font-weight:700;
      word-break: break-word;
    }
    .cell:hover{background: rgba(22,33,58,.95); border-color: rgba(255,255,255,.16);}
    .cell.taken{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 1px rgba(34,197,94,.10) inset;
      opacity:1;
    }
    .cell.locked{
      cursor:not-allowed;
      opacity:.75;
    }
    .cell.locked:hover{
      background: rgba(15,23,42,.85);
      border-color: rgba(255,255,255,.08);
    }

    .sectionTitle{margin-top:14px; font-size:13px; letter-spacing:.2px; color:#e5e7eb; font-weight:800;}
    .panel{background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px;}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{border-bottom:1px solid rgba(255,255,255,.06); padding:8px 6px; text-align:left; color:var(--text); vertical-align:top;}
    th{color:var(--muted); font-weight:700;}
    .note{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.35;}

    /* moved block: score+payout now lives between header and grid */
    .topPanels{
      margin-top: 12px;
    }
    .bottomRow{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}

    @media (max-width: 900px){
      .bottomRow{grid-template-columns:1fr;}
      .teamInput input{width:140px;}
      .boardArea{padding-left:54px;}
      .team1Top{left:54px;}
      .team2Side{width:54px;}
      .board{min-width:760px;}
      .adminBox{width:100%;}
    }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:420px;
      background: rgba(18,24,38,.98);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .modal h3{margin:0 0 8px 0; font-size:15px}
    .modal .meta{color: var(--muted); font-size:12px; margin-bottom:10px}
    .modal input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      outline:none;
      color: var(--text);
      font-weight:700;
    }
    .modal .row{display:flex; justify-content:flex-end; gap:10px; margin-top:10px;}
    .status{margin-top:10px; font-size:12px; color: var(--muted);}
    .status .ok{color: var(--accent)}
    .status .bad{color: var(--danger)}

    td[contenteditable="true"]{outline:none; border-radius:8px;}
    td[contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(96,165,250,.35);
      background: rgba(255,255,255,.04);
    }
    td.locked{cursor:not-allowed;}
  </style>
</head>

<body>
  <div class="wrap" id="pageRoot">
    <header>
      <div class="topRow">
        <div style="min-width: 280px;">
          <h1>Redzone Super Bowl Squares</h1>
          <div class="sub attention">
            TYPE YOUR NAME IN THE SQUARE(S) YOU WANT TO SELECT. <b>$10 / square</b>. First come, first served.
          </div>

          <div class="pillRow">
            <div class="pill">Blank Squares: <b id="blankCount">100</b></div>
            <div class="pill">Squares Selected: <b id="selectedCount">0</b></div>
            <div class="pill">Total Pot: <b id="totalPot">$0</b></div>
          </div>

          <div class="publicBtns" style="margin-top:10px;">
            <button class="btn" id="exportBtn" title="Download an image of the page">Export Image</button>
          </div>
        </div>

        <!-- âœ… Admin settings moved to the RIGHT of header block -->
        <div class="adminBox">
          <h3>
            Admin settings
            <span class="adminHint" id="lockBadge">UNLOCKED: NO â€¢ BOARD: OPEN</span>
          </h3>
          <div class="adminBtns">
            <button class="btn subtle" id="adminUnlockBtn" title="Unlock admin editing for this device">Admin Unlock</button>
            <button class="btn warn" id="lockBoardBtn" title="Lock/unlock board (admin)">Lock Board</button>
            <button class="btn primary" id="randomizeBtn" title="Randomize header numbers (admin)">Randomize 0â€“9</button>
            <button class="btn subtle" id="clearHeadersBtn" title="Clear header rows (admin)">Clear header rows</button>
          </div>
          <div class="note" style="margin-top:8px;">
            Please send your payments to taynikita@gmailcom
          </div>
        </div>
      </div>
    </header>

    <!-- âœ… MOVED: Score Tracker + Payout now live ABOVE the grid card -->
    <div class="gridCard topPanels">
      <div class="bottomRow">
        <div class="panel">
          <h2>SCORE TRACKER</h2>
          <table>
            <thead>
              <tr>
                <th></th>
                <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th id="team1Label">TEAM 1</th>
                <td id="t1q1" contenteditable="true"></td>
                <td id="t1q2" contenteditable="true"></td>
                <td id="t1q3" contenteditable="true"></td>
                <td id="t1q4" contenteditable="true"></td>
              </tr>
              <tr>
                <th id="team2Label">TEAM 2</th>
                <td id="t2q1" contenteditable="true"></td>
                <td id="t2q2" contenteditable="true"></td>
                <td id="t2q3" contenteditable="true"></td>
                <td id="t2q4" contenteditable="true"></td>
              </tr>
              <tr>
                <th>Winner</th>
                <td id="wq1">â€”</td>
                <td id="wq2">â€”</td>
                <td id="wq3">â€”</td>
                <td id="wq4">â€”</td>
              </tr>
            </tbody>
          </table>
          <div class="note">
            Enter the last digit of each teamâ€™s score for each quarter. Winner will auto-populate based on the matching square.
          </div>
        </div>

        <div class="panel">
          <h2>PAYOUT</h2>
          <table>
            <thead>
              <tr><th>Quarter</th><th>Name</th><th>Payout</th></tr>
            </thead>
            <tbody id="payoutRows">
              <tr><td>Q1</td><td contenteditable="true" data-pname="q1"></td><td contenteditable="true" data-ppay="q1"></td></tr>
              <tr><td>Q2</td><td contenteditable="true" data-pname="q2"></td><td contenteditable="true" data-ppay="q2"></td></tr>
              <tr><td>Q3</td><td contenteditable="true" data-pname="q3"></td><td contenteditable="true" data-ppay="q3"></td></tr>
              <tr><td>Q4</td><td contenteditable="true" data-pname="q4"></td><td contenteditable="true" data-ppay="q4"></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Original grid card content continues below -->
    <div class="gridCard">
      <div class="boardArea">
        <div class="team1Top">
          <div class="teamInput">
            <label>TEAM 1</label>
            <input id="team1" value="TEAM 1" />
          </div>
        </div>

        <div class="team2Side">
          <div class="teamInput">
            <label>TEAM 2</label>
            <input id="team2" value="TEAM 2" />
          </div>
        </div>

        <div class="boardScroll">
          <div class="board" id="board"></div>
        </div>
      </div>

      <div class="sectionTitle">PLAYERS</div>
      <div class="panel" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th style="width:48px;">#</th>
              <th>NAME</th>
              <th style="width:120px;"># OF SQUARES</th>
              <th style="width:140px;">AMOUNT OWED</th>
              <th style="width:140px;">AMOUNT PAID</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Claim modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3 id="modalTitle">Edit square</h3>
      <div class="meta" id="modalMeta"></div>
      <input id="nameInput" placeholder="Type your nameâ€¦" maxlength="22" />
      <div class="status" id="modalStatus"></div>
      <div class="row">
        <button class="btn" id="cancelBtn">Cancel</button>
        <button class="btn primary" id="confirmBtn">Save</button>
      </div>
      <div class="note">To release a square, delete all text and click Save.</div>
    </div>
  </div>

  <!-- Access code modal shown on page load -->
  <div class="modalBack" id="accessBack">
    <div class="modal">
      <h3>Enter Access Code</h3>
      <div class="meta">This pool is protected. Enter the code to continue.</div>
      <input id="accessInput" placeholder="Access code" />
      <div class="status" id="accessStatus"></div>
      <div class="row">
        <button class="btn primary" id="accessBtn">Enter</button>
      </div>
      <div class="note" id="firebaseStatus" style="margin-top:10px;"></div>
    </div>
  </div>

  <script type="module">
    /**********************
     * FIREBASE IMPORTS (CDN)
     **********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    /**********************
     * CONFIG
     **********************/
    const PRICE_PER_SQUARE = 10;

    // âœ… Access code updated
    const POOL_ACCESS_CODE = "REDZONE2026";
    const ACCESS_VERSION = "v1";

    const ADMIN_PASSWORD = "Edem";

    // ðŸ”§ Replace with YOUR Firebase config (Project settings â†’ Web app)
    const firebaseConfig = {
      apiKey: "AIzaSyAgO8eCKDswsIZ8dLDyaEmgIv8PberVO2w",
      authDomain: "superbowl-squares-2026.firebaseapp.com",
      databaseURL: "https://superbowl-squares-2026-default-rtdb.firebaseio.com",
      projectId: "superbowl-squares-2026",
      storageBucket: "superbowl-squares-2026.firebasestorage.app",
      messagingSenderId: "901124318776",
      appId: "1:901124318776:web:cefe12e220a2b4c83528cd"
    };

    // Change this per year (or per pool)
    const POOL_ID = "superbowl-2026-redzone";

    /**********************
     * STATE
     **********************/
    const defaultState = () => ({
      team1: "TEAM 1",
      team2: "TEAM 2",

      // headers start as blank (admin randomizes later)
      colNums: Array(10).fill(""),
      rowNums: Array(10).fill(""),

      squares: Array.from({length:10}, () =>
        Array.from({length:10}, () => ({ name: "", claimedAt: null }))
      ),

      amountPaid: {},
      payout: {
        q1: { name: "", payout: "" },
        q2: { name: "", payout: "" },
        q3: { name: "", payout: "" },
        q4: { name: "", payout: "" }
      },
      scores: {
        t1: { q1:"", q2:"", q3:"", q4:"" },
        t2: { q1:"", q2:"", q3:"", q4:"" }
      },

      // âœ… NEW: server-wide board lock (applies to everyone)
      locked: false
    });

    let state = defaultState();
    let selected = {r:null, c:null};

    // Firebase handles
    let app, db, auth;
    let userReady = false;
    let applyingRemote = false;

    // Admin session unlock (for editing areas)
    let adminUnlocked = false;

    /**********************
     * DOM
     **********************/
    const boardEl = document.getElementById("board");
    const blankCountEl = document.getElementById("blankCount");
    const selectedCountEl = document.getElementById("selectedCount");
    const totalPotEl = document.getElementById("totalPot");

    const team1El = document.getElementById("team1");
    const team2El = document.getElementById("team2");
    const team1Label = document.getElementById("team1Label");
    const team2Label = document.getElementById("team2Label");

    const modalBack = document.getElementById("modalBack");
    const modalMeta = document.getElementById("modalMeta");
    const nameInput = document.getElementById("nameInput");
    const modalStatus = document.getElementById("modalStatus");
    const cancelBtn = document.getElementById("cancelBtn");
    const confirmBtn = document.getElementById("confirmBtn");

    const playersBody = document.getElementById("playersBody");

    // Access modal
    const accessBack = document.getElementById("accessBack");
    const accessInput = document.getElementById("accessInput");
    const accessStatus = document.getElementById("accessStatus");
    const accessBtn = document.getElementById("accessBtn");
    const firebaseStatus = document.getElementById("firebaseStatus");

    // Admin header
    const adminUnlockBtn = document.getElementById("adminUnlockBtn");
    const lockBoardBtn = document.getElementById("lockBoardBtn");
    const lockBadge = document.getElementById("lockBadge");

    /**********************
     * ACCESS CODE (once on page load)
     **********************/
    function hasAccess(){
      return localStorage.getItem(`sb_pool_access_ok_${ACCESS_VERSION}`) === "1";
    }
    function setAccess(){
      localStorage.setItem(`sb_pool_access_ok_${ACCESS_VERSION}`, "1");
    }
    function showAccess(){
      accessBack.style.display = "flex";
      setTimeout(()=>accessInput.focus(), 50);
    }
    function hideAccess(){
      accessBack.style.display = "none";
      accessInput.value = "";
      accessStatus.textContent = "";
      firebaseStatus.textContent = "";
    }

    async function validateAccessAndConnect(){
      const entered = (accessInput.value || "").trim();
      if (entered !== POOL_ACCESS_CODE) {
        accessStatus.innerHTML = '<span class="bad">Incorrect code.</span>';
        return;
      }
      setAccess();
      accessStatus.innerHTML = '<span class="ok">Code accepted.</span>';

      try{
        firebaseStatus.textContent = "Connectingâ€¦";
        initFirebase();
        await ensureSignedIn();
        hideAccess();
      }catch(e){
        console.error(e);
        firebaseStatus.innerHTML = '<span class="bad">Firebase connection failed. Check config + rules.</span>';
      }
    }

    accessBtn.addEventListener("click", validateAccessAndConnect);
    accessInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") validateAccessAndConnect(); });

    /**********************
     * FIREBASE INIT
     **********************/
    function initFirebase(){
      if (app) return;
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
    }

    async function ensureSignedIn(){
      return new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, async (user) => {
          try{
            if (!user) {
              await signInAnonymously(auth);
              return;
            }
            userReady = true;
            firebaseStatus.textContent = "Connected.";
            startRealtimeSync();
            unsub();
            resolve();
          }catch(err){
            unsub();
            reject(err);
          }
        });
      });
    }

    function poolStateRef(){
      return ref(db, `pools/${POOL_ID}/state`);
    }

    async function bootstrapIfEmpty(){
      const snap = await get(poolStateRef());
      if (!snap.exists()){
        await set(poolStateRef(), defaultState());
      }
    }

    function startRealtimeSync(){
      bootstrapIfEmpty().catch(console.error);

      onValue(poolStateRef(), (snap) => {
        const remote = snap.val();
        if (!remote) return;
        applyingRemote = true;
        state = remote;

        // Ensure arrays/fields exist (older states)
        if (!Array.isArray(state.colNums) || state.colNums.length !== 10) state.colNums = Array(10).fill("");
        if (!Array.isArray(state.rowNums) || state.rowNums.length !== 10) state.rowNums = Array(10).fill("");
        if (typeof state.locked !== "boolean") state.locked = false;

        render();
        applyingRemote = false;
      });
    }

    function persistToFirebase(full){
      if (!userReady || applyingRemote) return;
      set(poolStateRef(), full).catch(console.error);
    }

    /**********************
     * ADMIN PASSWORD
     **********************/
    function promptAdminPassword(){
      const entered = prompt("Enter admin password:");
      return (entered || "").trim() === ADMIN_PASSWORD;
    }

    function ensureAdminUnlockedOnce(){
      if (adminUnlocked) return true;
      const ok = promptAdminPassword();
      if (ok) adminUnlocked = true;
      else alert("Incorrect admin password.");
      renderAdminBadge();
      return adminUnlocked;
    }

    function renderAdminBadge(){
      const unlockedTxt = adminUnlocked ? "YES" : "NO";
      const boardTxt = state.locked ? "LOCKED" : "OPEN";
      lockBadge.textContent = `UNLOCKED: ${unlockedTxt} â€¢ BOARD: ${boardTxt}`;
    }

    /**********************
     * ADMIN SETTINGS BUTTONS
     **********************/
    adminUnlockBtn.addEventListener("click", () => {
      ensureAdminUnlockedOnce();
      applyAdminLocks();
      renderAdminBadge();
    });

    lockBoardBtn.addEventListener("click", () => {
      if (!promptAdminPassword()) return alert("Incorrect admin password.");

      // When you lock/unlock the board, we also grant adminUnlocked to this device
      adminUnlocked = true;

      state.locked = !state.locked;
      persistToFirebase(state);
      render();
    });

    document.getElementById("randomizeBtn").addEventListener("click", () => {
      if (!promptAdminPassword()) return alert("Incorrect admin password.");

      state.colNums = shuffle([...Array(10)].map((_,i)=>i));
      state.rowNums = shuffle([...Array(10)].map((_,i)=>i));
      persistToFirebase(state);
      render();
    });

    document.getElementById("clearHeadersBtn").addEventListener("click", () => {
      if (!promptAdminPassword()) return alert("Incorrect admin password.");

      state.colNums = Array(10).fill("");
      state.rowNums = Array(10).fill("");
      persistToFirebase(state);
      render();
    });

    // Export whole page as an IMAGE (PNG)
    document.getElementById("exportBtn").addEventListener("click", async () => {
      try{
        const root = document.getElementById("pageRoot");
        const { default: html2canvas } = await import("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm");
        const canvas = await html2canvas(root, {
          backgroundColor: null,
          scale: Math.min(2, window.devicePixelRatio || 1)
        });

        canvas.toBlob((blob) => {
          if (!blob) return;
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "redzone-superbowl-squares.png";
          a.click();
          URL.revokeObjectURL(a.href);
        }, "image/png");
      }catch(e){
        console.error(e);
        alert("Export failed. Try again (or export from desktop).");
      }
    });

    /**********************
     * TEAM NAMES
     **********************/
    team1El.addEventListener("input", () => {
      state.team1 = team1El.value.trim() || "TEAM 1";
      persistToFirebase(state); renderLabels();
    });
    team2El.addEventListener("input", () => {
      state.team2 = team2El.value.trim() || "TEAM 2";
      persistToFirebase(state); renderLabels();
    });

    /**********************
     * CLAIM MODAL
     **********************/
    cancelBtn.addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });

    confirmBtn.addEventListener("click", () => {
      const r = selected.r, c = selected.c;
      if (r === null || c === null) return;

      if (state.locked && !adminUnlocked) {
        modalStatus.innerHTML = '<span class="bad">Board is locked.</span>';
        return;
      }

      const raw = (nameInput.value || "").trim();

      if (!raw) {
        state.squares[r][c].name = "";
        state.squares[r][c].claimedAt = null;
        persistToFirebase(state);
        render();
        closeModal();
        return;
      }

      state.squares[r][c].name = raw;
      state.squares[r][c].claimedAt = new Date().toISOString();

      persistToFirebase(state);
      render();
      closeModal();
    });

    function openModal(r,c){
      if (state.locked && !adminUnlocked) {
        alert("Board is locked.");
        return;
      }

      selected = {r,c};
      nameInput.value = state.squares[r][c].name || "";
      modalStatus.textContent = "";
      modalMeta.textContent = "";
      modalBack.style.display = "flex";
      setTimeout(()=>nameInput.focus(), 50);
    }
    function closeModal(){
      modalBack.style.display = "none";
      selected = {r:null, c:null};
      nameInput.value = "";
      modalStatus.textContent = "";
      modalMeta.textContent = "";
    }

    /**********************
     * RENDER
     **********************/
    function render(){
      renderLabels();
      renderBoard();
      renderCounts();
      renderPlayers();
      renderScoreTrackerFromState();
      renderWinners();
      renderPayoutFromState();
      applyAdminLocks();
      renderAdminBadge();
    }

    function renderLabels(){
      team1El.value = state.team1;
      team2El.value = state.team2;
      team1Label.textContent = state.team1;
      team2Label.textContent = state.team2;
    }

    function renderBoard(){
      boardEl.innerHTML = "";

      boardEl.appendChild(div("hcell cornerHidden", ""));

      for (let c=0; c<10; c++){
        const v = state.colNums?.[c];
        boardEl.appendChild(div("hcell", (typeof v === "number" ? String(v) : String(v || ""))));
      }

      for (let r=0; r<10; r++){
        const rv = state.rowNums?.[r];
        boardEl.appendChild(div("lcell", (typeof rv === "number" ? String(rv) : String(rv || ""))));

        for (let c=0; c<10; c++){
          const sq = state.squares[r][c];
          const cell = document.createElement("div");
          const hasName = ((sq.name || "").trim().length > 0);

          const lockedClass = (state.locked && !adminUnlocked) ? " locked" : "";
          cell.className = "cell" + (hasName ? " taken" : "") + lockedClass;
          cell.innerHTML = hasName ? escapeHtml(sq.name) : "Tap to claim";

          cell.addEventListener("click", () => {
            if (!hasAccess() || !userReady) return;
            if (state.locked && !adminUnlocked) {
              alert("Board is locked.");
              return;
            }
            openModal(r,c);
          });

          boardEl.appendChild(cell);
        }
      }
    }

    function renderCounts(){
      const taken = countTaken();
      blankCountEl.textContent = String(100 - taken);
      selectedCountEl.textContent = String(taken);
      totalPotEl.textContent = `$${taken * PRICE_PER_SQUARE}`;
    }

    function countTaken(){
      let t=0;
      for (let r=0; r<10; r++){
        for (let c=0; c<10; c++){
          if ((state.squares[r][c].name || "").trim()) t++;
        }
      }
      return t;
    }

    /**********************
     * PLAYERS TABLE
     **********************/
    function normalizeName(name){ return (name || "").trim(); }
    function keyName(name){ return normalizeName(name).toLowerCase(); }

    function computePlayers(){
      const map = new Map();
      for (let r=0; r<10; r++){
        for (let c=0; c<10; c++){
          const nm = normalizeName(state.squares[r][c].name);
          if (!nm) continue;
          const k = keyName(nm);
          if (!map.has(k)) map.set(k, { displayName: nm, count: 0 });
          map.get(k).count += 1;
        }
      }
      const arr = Array.from(map.entries()).map(([k,v])=>({ key:k, name:v.displayName, count:v.count }));
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      return arr;
    }

    function renderPlayers(){
      const players = computePlayers();
      playersBody.innerHTML = "";

      for (let i=0; i<30; i++){
        const p = players[i] || null;
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = String(i+1);
        tdIdx.style.color = "rgba(255,255,255,.7)";
        tr.appendChild(tdIdx);

        const tdName = document.createElement("td");
        tdName.textContent = p ? p.name : "";
        tr.appendChild(tdName);

        const tdCount = document.createElement("td");
        tdCount.textContent = p ? String(p.count) : "";
        tr.appendChild(tdCount);

        const tdOwed = document.createElement("td");
        tdOwed.textContent = p ? formatMoney(p.count * PRICE_PER_SQUARE) : "";
        tr.appendChild(tdOwed);

        const tdPaid = document.createElement("td");
        tdPaid.setAttribute("spellcheck", "false");
        tdPaid.dataset.pkey = p ? p.key : "";
        tdPaid.textContent = p ? (state.amountPaid?.[p.key] ?? "") : "";

        tdPaid.classList.add("locked");
        tdPaid.contentEditable = adminUnlocked ? "true" : "false";

        tdPaid.addEventListener("focus", () => {
          if (!tdPaid.dataset.pkey) return;
          if (adminUnlocked) return;
          if (ensureAdminUnlockedOnce()){
            applyAdminLocks();
            tdPaid.focus();
          } else {
            tdPaid.blur();
          }
        });

        tdPaid.addEventListener("blur", () => {
          if (!adminUnlocked) return;
          const key = tdPaid.dataset.pkey;
          if (!key) return;
          state.amountPaid = state.amountPaid || {};
          state.amountPaid[key] = (tdPaid.textContent || "").trim();
          persistToFirebase(state);
        });

        tr.appendChild(tdPaid);
        playersBody.appendChild(tr);
      }
    }

    function formatMoney(n){
      const num = Number(n);
      if (!isFinite(num)) return "";
      return `$${num.toFixed(0)}`;
    }

    /**********************
     * SCORE TRACKER
     **********************/
    const scoreCells = [
      ["t1","q1","t1q1"],["t1","q2","t1q2"],["t1","q3","t1q3"],["t1","q4","t1q4"],
      ["t2","q1","t2q1"],["t2","q2","t2q2"],["t2","q3","t2q3"],["t2","q4","t2q4"],
    ];

    function bindScoreTracker(){
      for (const [team, q, id] of scoreCells){
        const el = document.getElementById(id);

        el.addEventListener("focus", () => {
          if (adminUnlocked) return;
          if (ensureAdminUnlockedOnce()){
            applyAdminLocks();
            el.focus();
          } else {
            el.blur();
          }
        });

        el.addEventListener("input", () => {
          if (!adminUnlocked) return;

          const txt = (el.textContent || "").trim();
          const digit = txt === "" ? "" : txt.replace(/[^0-9]/g, "").slice(-1);
          if (digit !== txt) el.textContent = digit;

          state.scores = state.scores || { t1:{q1:"",q2:"",q3:"",q4:""}, t2:{q1:"",q2:"",q3:"",q4:""} };
          state.scores[team][q] = digit;

          persistToFirebase(state);
          renderWinners();
        });
      }
    }

    function renderScoreTrackerFromState(){
      for (const [team, q, id] of scoreCells){
        const el = document.getElementById(id);
        if (!el) continue;
        el.textContent = state?.scores?.[team]?.[q] || "";
      }
    }

    /**********************
     * WINNER CALCULATION
     **********************/
    function renderWinners(){
      const qs = ["q1","q2","q3","q4"];
      for (const q of qs){
        const t1d = state?.scores?.t1?.[q] || "";
        const t2d = state?.scores?.t2?.[q] || "";
        const winnerEl = document.getElementById("w" + q);

        if (!isDigit(t1d) || !isDigit(t2d)) {
          winnerEl.textContent = "â€”";
          continue;
        }

        const colIndex = indexOfDigit(state.colNums || [], Number(t1d));
        const rowIndex = indexOfDigit(state.rowNums || [], Number(t2d));

        if (colIndex === -1 || rowIndex === -1){
          winnerEl.textContent = "â€”";
          continue;
        }

        const nm = normalizeName(state.squares[rowIndex][colIndex].name);
        winnerEl.textContent = nm ? nm : "â€”";
      }
    }

    function isDigit(x){
      return typeof x === "string" && x.length === 1 && x >= "0" && x <= "9";
    }
    function indexOfDigit(arr, d){
      for (let i=0; i<arr.length; i++){
        if (arr[i] === d) return i;
      }
      return -1;
    }

    /**********************
     * PAYOUT (editable - admin only)
     **********************/
    function bindPayout(){
      for (const q of ["q1","q2","q3","q4"]){
        const nameCell = document.querySelector(`[data-pname="${q}"]`);
        const payCell  = document.querySelector(`[data-ppay="${q}"]`);
        if (!nameCell || !payCell) continue;

        const guard = (el) => {
          el.addEventListener("focus", () => {
            if (adminUnlocked) return;
            if (ensureAdminUnlockedOnce()){
              applyAdminLocks();
              el.focus();
            } else {
              el.blur();
            }
          });
          el.addEventListener("blur", () => {
            if (!adminUnlocked) return;
            state.payout = state.payout || { q1:{name:"",payout:""}, q2:{name:"",payout:""}, q3:{name:"",payout:""}, q4:{name:"",payout:""} };
            state.payout[q].name = (nameCell.textContent || "").trim();
            state.payout[q].payout = (payCell.textContent || "").trim();
            persistToFirebase(state);
          });
        };

        guard(nameCell);
        guard(payCell);
      }
    }

    function renderPayoutFromState(){
      for (const q of ["q1","q2","q3","q4"]){
        const nameCell = document.querySelector(`[data-pname="${q}"]`);
        const payCell  = document.querySelector(`[data-ppay="${q}"]`);
        if (nameCell) nameCell.textContent = state?.payout?.[q]?.name || "";
        if (payCell)  payCell.textContent  = state?.payout?.[q]?.payout || "";
      }
    }

    /**********************
     * Apply admin locks to editables
     **********************/
    function applyAdminLocks(){
      for (const [, , id] of scoreCells){
        const el = document.getElementById(id);
        if (!el) continue;
        el.contentEditable = adminUnlocked ? "true" : "false";
      }

      for (const q of ["q1","q2","q3","q4"]){
        const nameCell = document.querySelector(`[data-pname="${q}"]`);
        const payCell  = document.querySelector(`[data-ppay="${q}"]`);
        if (nameCell) nameCell.contentEditable = adminUnlocked ? "true" : "false";
        if (payCell)  payCell.contentEditable  = adminUnlocked ? "true" : "false";
      }

      const paidCells = playersBody.querySelectorAll('td[data-pkey]');
      paidCells.forEach(td => {
        td.contentEditable = (adminUnlocked && td.dataset.pkey) ? "true" : "false";
        if (!adminUnlocked) td.classList.add("locked"); else td.classList.remove("locked");
      });
    }

    /**********************
     * HELPERS
     **********************/
    function div(cls, text){
      const d = document.createElement("div");
      d.className = cls;
      d.textContent = text;
      return d;
    }
    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    /**********************
     * INIT
     **********************/
    bindScoreTracker();
    bindPayout();

    if (!hasAccess()) {
      showAccess();
    } else {
      try{
        initFirebase();
        await ensureSignedIn();
      }catch(e){
        console.error(e);
        showAccess();
        firebaseStatus.innerHTML = '<span class="bad">Firebase connection failed. Check config + rules.</span>';
      }
    }

    render();
  </script>
</body>
</html>
